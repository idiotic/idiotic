version: 1
global: {}
cluster:
  listen: '0.0.0.0'
  rpc_port: 28301
  port: 28300
nodes:
  muffin:
    host: 192.168.1.191
  scootaloo:
    host: 192.168.5.3
  luna:
    host: 192.168.5.6
modules:
  x10:
    base_url: http://vinyl.hackafe.net:5000
  espeak:
    command: espeak --stdout | paplay
blocks:
  zero:
    type: Value
    kind: Float
    initial: 0.0

{% macro temperature(pi, room) %}
  {{ room }}_dht:
    type: DHT
    pin: 24
    interval: 5
    require:
      - node={{ pi }}
  {{ room }}_temp_nonzero:
    type: NotEqualBlock
    inputs:
      a: {{ room }}_dht.temperature
      b: zero
  {{ room }}_hum_nonzero:
    type: NotEqualBlock
    inputs:
      a: {{ room }}_dht.humidity
      b: zero
  {{ room }}_temp:
    type: OutputIfBlock
    inputs:
      condition: {{ room }}_temp_nonzero
      value: {{ room }}_dht.temperature
    input_to:
      - average_temp.{{ room }}
  {{ room }}_humidity:
    type: OutputIfBlock
    inputs:
      condition: {{ room }}_hum_nonzero
      value: {{ room }}_dht.humidity
    input_to:
      - average_humidity.{{ room }}
{% endmacro %}

{% macro motion(pi, room, pin=13) %}
  {{ room }}_motion_{{ pin}}:
    type: RPiGPIO
    device: MotionSensor
    options:
      pin: {{ pin }}
    require:
      - node={{ pi }}
{% endmacro %}


{# {% for room, pi in zip(
  ['bed_room', 'living_room', 'hall', 'entertainment_room',],
  ['rarity', 'luna', 'scootaloo', 'vinyl',]
) %}
{{ temperature(pi, room) }}
{% endfor %} #}
{{ temperature('scootaloo', 'hall') }}
{{ temperature('luna', 'living_room') }}
{{ motion('luna', 'living_room') }}

  average_temp:
    type: AverageBlock
    initial: 0
    default: 0
  average_humidity:
    type: AverageBlock
    initial: 0
    default: 0
  periodic_1:
    type: RandomList
    period: 6
    items:
      - True

{% set annoying = False %}
{% if annoying %}
  speech:
    type: Speech
    text: It is {temperature:.1f} degrees and {humidity:.0f} percent humid
    parameters:
      - temperature
      - humidity
    inputs:
      temperature: average_temp
      humidity: average_humidity
    require:
      - node=muffin
  teakettle:
    address: 'https://api.particle.io'
    path: '/v1/devices/'
    access_token: 'fe7e8d11c02660ee0cfd37e5a508e184bf95a858'
    device_id: '210035001447343338333633'
    inputs:
      temperature: 'random_temp'
      hold: 'random_hold'
    type: TeapotBlock
  random_temp:
    period: 5
    min: 90
    max: 100
    type: RandomFloatBlock
  random_hold:
    period: 5
    min: 60
    max: 100
    type: RandomFloatBlock
  record_light:
    client_secret: "e749124ad386a5a35c0ab554a4f2c045"
    username: "dylan@whichard.com"
    password: "mZc9sQXa"
    wink_name: "Corner Light"
    inputs:
      power: "random_power"
    type: WinkDimmer
    require:
      - node=muffin
  test:
    type: HTTP
    url: http://vinyl.hackafe.net:5000/{power}/a/3
    skip_repeats: True
    parameters:
      - power
    defaults:
      power: "off"
    inputs:
      power: random_state
  stairs_lights:
    type: HTTP
    method: post
    url: http://celestia.hackafe.net/put_saved_animation/{animation}'
    parameters:
      - animation
    inputs:
      animation: light_pattern
  light_pattern:
    type: RandomList
    period: 10
    items:
      - Rainbow
      - Redstrobe
      - Greenstrobe
      - Bluestrobe
      - Strobey
  random_state:
    type: RandomList
    period: 20
    items:
      - "on"
      - "off"
  counter_lights:
    type: X10
    code: A4
    inputs:
      power: random_power
  random_power:
    type: RandomBoolBlock
    period: 5
{% endif %}